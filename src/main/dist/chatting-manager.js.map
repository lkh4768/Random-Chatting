{"version":3,"sources":["../es6/chatting-manager.js"],"names":["SessionManager","require","Message","ChattingManager","_sessionManager","_events","close","id","had_error","console","log","partnerId","getPartnerIdById","destroySessionById","SERVERID","_reconnectPartnerById","error","data","buf","msg","WAITING_TEXT","_send","drain","end","timeout","clientSocket","session","addSession","welcomeText","WELCOME_TEXT","_connectPartnerById","callback","from","to","text","getSessionById","socket","write","ENCODING","setPartnerById","module","exports"],"mappings":"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","file":"chatting-manager.js","sourcesContent":["const SessionManager = require('./session-manager.js'), Message = require('./message.js');\nclass ChattingManager{\n\tconstructor(){\n\t\tthis._sessionManager = new SessionManager();\n\t\tthis._events = {\n\t\t\tclose :(id, had_error)=>{\n\t\t\t\tconsole.log(`close session(${id}), had error(${had_error})`);\n\t\t\t\tlet partnerId = this._sessionManager.getPartnerIdById(id);\n\t\t\t\tthis._sessionManager.destroySessionById(id);\n\t\t\t\tif(partnerId !== SessionManager.SERVERID)this._reconnectPartnerById(partnerId);\n\t\t\t},\n\t\t\terror :(id, error)=>{\n\t\t\t\tconsole.log(`error(${error}) session(${id})`);\n\t\t\t\tthis._sessionManager.destroySessionById(id);\n\t\t\t},\n\t\t\tdata :(id, buf)=>{\n\t\t\t\tconsole.log(`data(${buf}) session(${id})`);\n\t\t\t\tconst partnerId = this._sessionManager.getPartnerIdById(id);\n\t\t\t\tlet msg;\n\t\t\t\tif(partnerId !== SessionManager.SERVERID) msg = new Message(partnerId, id, buf);\n\t\t\t\telse msg = new Message(id, SessionManager.SERVERID, ChattingManager.WAITING_TEXT); \n\t\t\t\tthis._send(msg);\n\t\t\t},\n\t\t\tdrain :(id)=>{\n\t\t\t\tconsole.log(`drain session(${id})`);\n\t\t\t},\n\t\t\tend :(id)=>{\n\t\t\t\tconsole.log(`end session(${id})`);\n\t\t\t},\n\t\t\ttimeout :(id)=>{\n\t\t\t\tconsole.log(`timeout session(${id})`);\n\t\t\t\tthis._sessionManager.destroySessionById(id);\n\t\t\t}\n\t\t};\n\t}\n\tenterClient(clientSocket){\n\t\tconst session = this._sessionManager.addSession(clientSocket, this._events)\n\t\t\t, welcomeText = `${ChattingManager.WELCOME_TEXT} ${session.id} user.\\n`\n\t\t\t, msg = new Message(session.id, SessionManager.SERVERID, welcomeText);\n\t\tthis._send(msg);\n\t\tthis._connectPartnerById(session.id);\n\t}\n\t_send(msg, callback){\n\t\tif(!callback)\n\t\t\tcallback = ()=>{\n\t\t\t\tconsole.log(`user(${msg.from}) -> user(${msg.to}), Sended message(${msg.text})`);\n\t\t\t};\n\t\tthis._sessionManager\n\t\t\t.getSessionById(msg.to)\n\t\t\t.socket\n\t\t\t.write(`user(${msg.from}) -> user(${msg.to}): ${msg.text}`, ChattingManager.ENCODING, callback);\n\t}\n\t_connectPartnerById(id){\n\t\tlet text;\n\t\tif(this._sessionManager.setPartnerById(id)){\n\t\t\tlet partnerId = this._sessionManager.getPartnerIdById(id);\n\t\t\ttext=`Found user(${partnerId}) to chatting. Enjoy chatting^^\\n`;\n\t\t\tthis._send(new Message(partnerId, SessionManager.SERVERID, `Found user(${id}) to chatting. Enjoy chatting^^\\n`));\n\t\t}\n\t\telse{\n\t\t\ttext=ChattingManager.WAITING_TEXT;\n\t\t}\n\t\tthis._send(new Message(id, SessionManager.SERVERID, text));\n\t}\n\t_reconnectPartnerById(id){\n\t\tthis._send(new Message(id, SessionManager.SERVERID, 'your partner is gone. we are finding new partner...'));\n\t\tthis._connectPartnerById(id);\n\t}\n}\n\nChattingManager.WELCOME_TEXT = 'Welcome!!!';\nChattingManager.WAITING_TEXT = 'Can\\'t found other user to chatting. Please wait....\\n';\nChattingManager.ENCODING = 'utf8';\nmodule.exports=ChattingManager;\n"]}